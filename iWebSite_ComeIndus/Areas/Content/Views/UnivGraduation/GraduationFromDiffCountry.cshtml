<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<head>
    <link rel="stylesheet" href="~/css/unisamestyle.css">
    <style>
        .down {
            position: absolute;
            right: 20px;
            bottom: 10px;
        }

        .top {
            position: absolute;
            right: 0px;
            top: 50px;
            color:#3BB0A2;
            font-weight: bold;
        }

    </style>
</head>

<!-- HTML -->
<header id="tai">
    <button class="button btn btn-link btn-lg top" href="/Content/UnivGraduation/DiffYear">前往同國比較>></button>
    <div class="container sty1">
        <div class="title">
            <h2 class="tai">Taiwan</h2>
            <h2 class="sin">Singapore</h2>
        </div>
        <div class="years">
            <select class="taiyears" onchange="getData(this)">
                <option value="2019">2019</option>
                <option value="2018">2018</option>
                <option value="2017">2017</option>
                <option value="2016">2016</option>
                <option value="2015">2015</option>
            </select>
        </div>
        <div class="box">
            <div class="chartdiv" id="chartdiv1"></div>
            <div class="chartdiv" id="chartdiv2"></div>
        </div>
 <button class="btn btn-light btn-lg down">下載</button>
    </div>
</header>

<!-- Chart code -->
<script>
    var D;
    function getData(selectedObj) {
        $.ajax({
            type: "GET",
            url: "/Content/UnivGraduation/GraduationFromDiffCountry",
            data: { year: selectedObj.value },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            async: true,
            beforeSend: function () {
                // null
            },
            success: function (data) {
                console.log(data);

                taiobj = data["中國"]
                var deptName = taiobj.deptName
                var gradNum = taiobj.graduationNumber
                var inum = []
                deptName.forEach((v, i) => inum.push({ "deptName": deptName[i], "studentNum": gradNum[i] }));
                drawChart(inum, "chartdiv1")

                sinobj = data["新加坡"]
                var sinDeptName = sinobj.deptName
                var singGadNum = sinobj.graduationNumber
                var inum2 = []
                sinDeptName.forEach((v, i) => inum2.push({ "depName": sinDeptName[i], "studentNum": singGadNum[i] }));
                drawChart(inum2, "chartdiv2")
            },
            error: function (e) {
                console.log(e);
            }
        });
    }
    

    function drawChart(data, name) {  // 4. 這時這裡的data就會是inum
        am4core.ready(function () {
            var chartIndex = am4core.registry.baseSprites.findIndex((v) => v.htmlContainer.id == name);
            if (chartIndex != -1) {
                am4core.registry.baseSprites[chartIndex].data = data;
            } else {
                // Themes begin
                am4core.useTheme(am4themes_animated);
                // Themes end

                // Create chart instance
                var chart = am4core.create(name, am4charts.PieChart);
                // Add data
                chart.data = data;
                // Add and configure Series
                var pieSeries = chart.series.push(new am4charts.PieSeries());
                pieSeries.dataFields.value = "studentNum";
                pieSeries.dataFields.category = "deptName";
                pieSeries.slices.template.stroke = am4core.color("#fff");
                pieSeries.slices.template.strokeOpacity = 1;

                // This creates initial animation
                pieSeries.hiddenState.properties.opacity = 1;
                pieSeries.hiddenState.properties.endAngle = -90;
                pieSeries.hiddenState.properties.startAngle = -90;

                chart.hiddenState.properties.radius = am4core.percent(0);
            }

        }); // end am4core.ready()
    }
    getData({ value: 2019 });
</script>